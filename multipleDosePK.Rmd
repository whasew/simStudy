---
title: "Simulate 3 cmt catenary chain"
author: "Willi"
date: "06.04.2015"
output: ioslides_presentation
---

## use of prior knowledge of APAP PK

in 70 kg adults:
- parent CL 0.3 l/h/kg, Vd=1l/kg, t12= 3-4 h
- urinary excretion glucuronide 60%, sulfate 35%, renal clearance GFR=120*.06=7.2 l/h=0.1 l/h/kg

from experience:

- CL variability 40% metabolism, 20 % renal
- Vd variability 20%



## objectives

- simulate pk model with prior parameter 


## number of patients, simulated weight distribution

```{r dosewt}
source("lib/helpers.R")
nid <- 15
MW<-150
weight_gmean <- 70
weight_gmean <- 2.8
weight_sd95 <- 0.2
IVdose <- 15*1000/MW  # umol/kg
tinf<-0.5 #h
rate<-IVdose/tinf
tau<-24
time <- exp(seq(log(0.1),log(48),length=16))
time <- exp(seq(log(0.1),log(tau),length=6))
#time <- exp(c(seq(log(0.1),log(24),length=11), seq(log(24.5), log(48), length=6)))


## variance components
## random effects on CL and V


```

## utility functions to generate system matrices

```{r systemMatrix}
systemODE_1cmt_m2 <- function(lMRT10, lMRT20, lMRT30, lfm1, lfm2) {
    k10 <- exp(-lMRT10)
    k12 <- exp(lfm1) * k10
    k13 <- exp(lfm2) * k10
    k20 <- exp(-lMRT20)
    k30 <- exp(-lMRT30)
    A <- rbind(
        c(-k10,    0,    0),
        c( k12, -k20,    0),
        c( k13,    0, -k30))
    A
}

```




## population medians, means for the log-normals (or the geometric mean)



```{r poppk}
CL<-c(0.3,0.1,0.1) # l/h/kg
V<-c(1,.9,1.2) # l/kg
MRT<-V/CL
MRT*log(2)
fm1 <- 0.6 ## note: this is FIXED right now
fm2 <- 0.3 ## note: this is FIXED right now
omega <- c(CL=0.4, V=0.2)
omMRT<-sqrt(omega[2]^2+omega[1]^2)
sigma <- c(0.1, 0.1, 0.1)

truth <- c(MRT, V)
Ttruth <- log(truth)


```



# parent pk parameter distribution

```{r pdf}
library(mvtnorm)
set.seed(27245)
stdnorm<-as.data.frame(rmvnorm(nid,rep(0,length(Ttruth)),sigma=diag(length(Ttruth))))
names(stdnorm)
ppk<-data.frame(id=1:nid
           ,weight=rlnorm(nid, log(weight_gmean), weight_sd95/1.96)
           )
           
ppk<-cbind(ppk,stdnorm)   
ppk<-transform(ppk
          ,dose=IVdose
          ,rate=IVdose/tinf
          ,lMRT10=Ttruth[1]+V1*omMRT+ 0.25 * log(weight/weight_gmean)
          ,lMRT20=Ttruth[2]+V2*omMRT+ 0.25 * log(weight/weight_gmean)
          ,lMRT30=Ttruth[3]+V3*omMRT+ 0.25 * log(weight/weight_gmean)
          ,lV1=Ttruth[4]+V4*omega["V"]+ log(weight/weight_gmean)
          ,lV2=Ttruth[5]+V5*omega["V"]+ log(weight/weight_gmean)
          ,lV3=Ttruth[6]+V6*omega["V"]+ log(weight/weight_gmean)
          ,lfm1=log(fm1)
          ,lfm2=log(fm2)
          )
pars <- transform(ppk
                 ,lk12=log(fm1) - lMRT10
                 ,lk13=log(fm2) - lMRT10
                 )
           
```


# PK after 5 APAP infusions

```{r sim}
source("src/matrixODE.R")
library(foreach)
library(reshape2)
library(plyr)
J<-nid
nDose<-5
tau<-12
inftime<-exp(seq(log(0.1),log(tinf),length=4))
washtime<-  exp(seq(log(0.6),log(tau),length=6))
time<-c(inftime,washtime,tau+inftime)
sim <- foreach(j=1:J, .combine=rbind) %do% {
    sol <- matrixODE(do.call(systemODE_1cmt_m2, pars[j,c("lMRT10", "lMRT20", "lMRT30", "lfm1", "lfm2")]))
    sol1 <- cmt_select(sol, 1)
    sol2 <- cmt_select(sol, 2)
    sol3 <- cmt_select(sol, 3)
    IVdose_j <- IVdose ##rlnorm(1, log(IVdose), log(1.1))
    ##x0 <- c(IVdose_j,0,0)
    ##b <- c(0, 0, 0)
    
    b <- c(rate, 0, 0)
    b2 <- c(0, 0, 0)
    time1 <- inftime
    time2 <- washtime - tinf
    ## infusion
    tdose<-0
    x0 <- c(0,0,0)
    ddo<-as.data.frame(t(x0))
    ddo<-transform(ddo,time=0,evid=1)
    dd1 <- as.data.frame(t(sol(time1, x0, b)))
    dd1<-transform(dd1,time=time1,evid=0)
    dd1<-rbind(ddo,dd1)
    ##washout
    x0<-as.vector(sol(tinf, x0, b))
    dd2 <- as.data.frame(t(sol(time2,x0, b2)))
    dd2<-transform(dd2,time=washtime,evid=0)
    dd2
    
#nDose<-2
      ddd <- foreach(nDose=1:nDose, .combine=rbind) %do% {
      #print(nDose)
      ## infusion
      x0<-as.vector(sol(tau-tinf, x0, b2))
      ddo<-as.data.frame(t(x0))
    ddo<-transform(ddo,time=(nDose-1)*tau,evid=1)
    dd3 <- as.data.frame(t(sol(time1,x0, b)))
     dd3<-transform(dd3,time=(nDose-1)*tau+time1,evid=0)
    dd3<-rbind(ddo,dd3)
    #dd3
    ##washout
  x0<-   as.vector(sol(tinf, x0, b))
  dd4 <- as.data.frame(t(sol(time2,x0, b2)))
   dd4<-transform(dd4,time=(nDose-1)*tau+washtime,evid=0)
    rbind(dd3,dd4)
  }
  
  dd <- transform(rbind(dd1,dd2,ddd), V1=V1/exp(pars$lV1[j]), V2=V2/exp(pars$lV2[j]), V3=V3/exp(pars$lV3[j]))
subset(dd,evid==1)
    M <- melt(dd, id.vars=c("time","evid"))


M
    obs <- data.frame(id=j, sdv=M$value, time=M$time, amt=0, rate=0, evid=M$evid, mdv=0, cmt=as.numeric(M$variable))
obs[obs$evid==1,]<-transform(obs[obs$evid==1,],amt=IVdose,rate=IVdose/tinf)
    obs$dv <- obs$sdv
    obs$dv[obs$cmt==1] <- obs$dv[obs$cmt==1] * rlnorm(nrow(dd), 0, sigma[1])
    obs$dv[obs$cmt==2] <- obs$dv[obs$cmt==2] * rlnorm(nrow(dd), 0, sigma[2])
    obs$dv[obs$cmt==3] <- obs$dv[obs$cmt==3] * rlnorm(nrow(dd), 0, sigma[3])
subset(obs,evid==1&cmt==1)
obs<-subset(obs,!(evid==1&cmt%in%c(2,3)))
##    amt <- data.frame(id=j, sdv=0, time=0, amt=IVdose_j, rate=b[1], evid=1, mdv=1, cmt=1, dv=0 )
#    res <- arrange(rbind(amt, obs), time, cmt)
    res <- arrange(obs, time, cmt)
    cbind(res, weight=pars$weight[j])
}

## discard dv when system is still equal to 0 as we calculate in log-space
sim <- subset(sim, !(time==0 & evid==0))

#sim<-transform(sim,met=factor(cmt,levels=1:3,labels=c("APAP","GLUC","SULF")))

sim<-transform(sim,met=factor(as.character(cmt),levels=c("1","2","3"),labels=c("AP","GL","SU")))
#levels(sim$met)<-list("1"="APAP", "2"="GLUC", "3"="SULF")
levels(sim$met)
head(sim,20)
subset(sim,id==1&cmt==2)

```


## figure PK


```{r pk,echo=FALSE,message=FALSE,warning=FALSE}
library(nlme)
gd<-groupedData(dv~time|id,subset(sim,sdv>1E-5),outer=~met)
plot(gd,outer=T,key=F,scale=list(y="free"))

```

## figure log


```{r figlog,echo=FALSE}
plot(gd,outer=T,key=F,scale=list(y=xyLogscale()),aspect="fill")
```

## figure log day1

```{r day1,echo=FALSE,warning=FALSE}
plot(subset(gd,time<24.1),outer=T,key=F,scale=list(y=xyLogscale()),aspect="fill")
```

## figure log last day

```{r daylast,echo=FALSE,warning=FALSE}
plot(subset(gd,time>(nDose-1)*tau),outer=T,key=F,scale=list(y=xyLogscale()),aspect="fill")
```








